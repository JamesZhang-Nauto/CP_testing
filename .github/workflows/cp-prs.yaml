on:
  pull_request:
    branches:
      - master
      - '*-release' # This matches all branches ending with '-release'
    types: ["closed"]

jobs:
  cherry_pick:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged == true }}
    steps:
      - name: Set branch name from PR labels
        id: set-branch
        run: |
          # Default to empty
          TARGET_BRANCH=""
          
          # Loop through labels
          for label in "${{ github.event.pull_request.labels.*.name }}"; do
            if [ "$label" == "master" ]; then
              TARGET_BRANCH="master"
              break
            elif [[ "$label" == *-release ]]; then
              TARGET_BRANCH="$label"
              break
            fi
          done
          
          # Fail if no valid branch is found
          if [ -z "$TARGET_BRANCH" ]; then
            echo "No valid branch label (master or *-release) found, exiting."
            exit 1
          fi
          
          # Set the branch name as an output variable
          echo "target_branch=$TARGET_BRANCH" >> $GITHUB_ENV
          
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          token: ${{ secrets.BOT_PERMISSION }}

      - name: Cherry pick into the target branch
        uses: carloscastrojumo/github-cherry-pick-action@v1.0.9
        with:
          branch: ${{ env.target_branch }}
          labels: |
            CP
          reviewers: |
            ${{ github.event.pull_request.user.login }}
          title: '{old_title} [CP to ${{ env.target_branch }}]'
          body: 'Cherry picking #{old_pull_request_id} onto ${{ env.target_branch }}'
          inherit_labels: false
          token: ${{ secrets.BOT_PERMISSION }}
