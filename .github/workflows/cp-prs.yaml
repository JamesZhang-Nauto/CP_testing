on:
  pull_request:
    branches:
      - master
      - '*-release' # This matches all branches ending with '-release'
    types: ["closed"]

jobs:
  cherry_pick_dispatcher:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged == true }}
    steps:
      - name: Set branch names from PR labels
        id: set-branches
        run: |
          # Ensure jq is installed
          sudo apt-get update && sudo apt-get install -y jq

          # Fetch all labels and filter them
          labels=$(jq -r '.pull_request.labels[].name' "$GITHUB_EVENT_PATH")
          echo "Labels on the PR: $labels"

          # Initialize an empty array for target branches
          TARGET_BRANCHES=()

          for label in $labels; do
            echo "Check label: $label"
            case "$label" in
              "master")
                TARGET_BRANCHES+=("master")
                ;;
              *-release)
                TARGET_BRANCHES+=("$label")
                ;;
            esac
          done

          # Fail if no valid branches are found
          if [ ${#TARGET_BRANCHES[@]} -eq 0 ]; then
            echo "No valid branch labels (master or *-release) found, exiting."
            exit 1
          fi

          # Join the array into a string separated by commas
          TARGET_BRANCHES_STR=$(IFS=, ; echo "${TARGET_BRANCHES[*]}")

          # Set the branches as an output variable
          echo "target_branches=$TARGET_BRANCHES_STR" >> $GITHUB_OUTPUT
        shell: bash

      - name: Dispatch cherry-pick workflows
        uses: actions/github-script@v6
        with:
          script: |
            const branches = '${{ steps.set-branches.outputs.target_branches }}'.split(',');
            const prNumber = context.payload.pull_request.number;
            for (const branch of branches) {
              console.log(`Dispatching cherry-pick workflow for branch: ${branch}`);
              await github.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'cherry-pick.yml',
                ref: 'main',  // Adjust this if your default branch is not 'main'
                inputs: {
                  pull_request_number: prNumber.toString(),
                  branch: branch
                }
              });
            }
